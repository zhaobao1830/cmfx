<admintpl file="header" />
<style>
    .wrap-zb{
        min-width: 1160px;
        overflow: hidden;
    }
    .treeDemo_zb_left{
        width: 23%;
        float: left;
        border: 1px solid #dddddd;
    }
    .orginization_title{
        height: 40px;
        line-height: 40px;
        background-color: #eeeeee;
        border-left: 1px solid #dddddd;
        border-right: 1px solid #dddddd;
        text-align: center;
        color: #4ea0ea;
        font-size: 16px;
    }
    .ztree_zb{
        margin-top: 0 !important;
    }
    .ztree_zb li span.button.add {
        margin-left:2px;
        margin-right: -1px;
        background-position:-144px 0;
        vertical-align:top;
        *vertical-align:middle
    }
    .zb_authority_ul li{
        list-style: none;
        float: left;
        margin-right: 20px;
    }
    .authority_zb{
        margin: 0 !important;
    }
    ul.ztree{
        margin: 0 !important;
        border: none !important;
        background-color: #fff !important;
        width: auto !important;
        min-height: 200px;
        max-height: 650px;
    }
    .ztree li span.button.edit{
        background-position: -107px -47px !important;
    }
    .treeDemo_zb_right{
        width: 73%;
        float: left;
        border-top: 1px solid #dddddd;
    }
    .authorityList{
        float: left;
        width: 100%;
    }




    .addNode{
        width: 300px;
        height: 200px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid #ddd;
    }
    .authorityList_con{
        width: 100%;
        min-width: 700px;
        float: left;
        position: relative;
        border: 1px solid #dddddd;
    }
    .has_authorityList{
        width: 100%;
        float: left;
        border-bottom: 1px solid #dddddd;
    }
    .has_authorityList_key{
        float: left;
        color: #464646;
        font-size: 14px;
        padding: 30px 0 30px 10px;
        font-weight: bold;
    }
    .has_authorityList_value,.has_ayList_value{
        padding: 30px 0 110px;
        overflow: hidden;
    }
    .all_authorityList_search p{
        display: inline-block;
        margin-left: 20px;
        border: none !important;
    }
    .all_authorityList_search input{
        margin-bottom: 0 !important;
    }
   .all_authorityList_search a{
        display: inline-block;
        height: 28px;
        line-height: 28px;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        font-size: 12px;
        color: #000000;
        margin-left: 5px;
        padding: 0 10px;
        text-decoration: none;
    }
    .all_authorityList_search a:hover{
        background-color: #3aa8e8;
    }
    .value_label{
        margin-left: 30px;
        float: left;
    }
    .value_label_span{
        margin-left: 10px !important;
        display: inline-block;
    }
    .vauel_label_input{
        display: inline-block;
        float: left;
    }

    .authorityEdit{
        width: 100%;
        text-align: center;
        margin-top: 20px;
        overflow: hidden;
        float: left;
    }

    .authorityEdit > a {
        width: 58px;
        display: inline-block;
        height: 30px;
        line-height: 30px;
        font-size: 14px;
        color: #fff;
        background-color: #3aa8e8;
        border-radius: 4px;
        text-decoration: none;
    }
    .authorityEdit > a:hover{
        background-color: #3aa8e8;
    }


    .paginationUserList{
        margin: 0 0 0 10px;
        position: absolute;
        bottom: 50px;
    }
    .pagination>a{
        color: #4ea0ea !important;
    }
    .paginationUserList a{
        display: block;
        line-height: 30px !important;
        height: 30px !important;
        text-align: center;
        font-size: 12px;
        cursor: pointer;
        text-decoration: none !important;
    }
    .paginationUserList a:hover{
        background-color: #3aa8e8 !important;
    }
    .tableButton_orginization{
        width: 364px;
        float: right;
        margin-right: 20px;
        margin-top: 20px;
    }
    .goFirst_orginization,.goLast_orginization{
        width: 44px;
    }
    .prePage_orginization,.nextPage_orginization{
        width: 56px;
    }
    .prePage_orginization{
        margin-left: 5px;
    }
    .nextPage_orginization{
        margin-right: 5px;
    }
    .currentPage_countPage_orginization{
        width: 45px;
        float: left;
        color: #3aa8e8;
        text-align: center;
        height: 30px;
        line-height: 30px;
    }
    .goFirst_orginization,.goLast_orginization,.prePage_orginization,.nextPage_orginization{
        border: 1px solid #bbbbbb;
        background-color: #fafafa;
        color: #777777;
        border-radius: 2px;
        float: left;
    }
    .pages_orginization{
        display: block !important;
        width: 44px;
        height: 28px !important;
        line-height: 30px !important;
        text-align: center;
        border: 1px solid #3aa8e8;
        padding: 0 !important;
        margin-left: 5px;
        margin-right: 5px;
        margin-bottom: 0 !important;
        border-radius: 2px;
        float: left;
        color: #3aa8e8;
    }
    .goPage_orginization{
        width: 44px;
        height: 30px;
        line-height: 30px;
        color: white;
        border-radius: 2px;
        font-size: 14px;
        background-color: #3aa8e8;
        float: left;
    }
    .goPage_orginization:hover{
        background-color: #4986c6;
    }

    .displayNone{
        display: none;
    }
    .displayBlock{
        display: block;
    }
</style>
</head>
<body>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/ztree/demo.css">
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/ztree/zTreeStyle.css">
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.core.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.all.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.exedit.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.exhide.js"></script>
  <div class="wrap wrap-zb">
      <!--保存当前点击的节点的ID-->
      <input type="hidden" class="clickNoneId" value="">
      <input type="hidden" class="clickNowId" value="">
      <div class="treeDemo_zb_left span3">
          <div class="ztree_zb_title orginization_title">组织树</div>
          <div class="ztree_zb_ul">
              <ul id="treeDemo" class="ztree ztree_zb"></ul>
          </div>
      </div>
      <div class="treeDemo_zb_right span9">
          <div class="authorityList">
              <div class="authorityList_title orginization_title"><span class="nowNodeName"></span>--权限列表</div>
              <div class="authorityList_con">
                  <div class="has_authorityList">
                      <div class="has_authorityList_key">已有权限</div>
                      <div class="has_ayList_value">
                          <ul id="authorityTreeDemo" class="ztree ztree_zb"></ul>
                      </div>
                  </div>
              </div>
          </div>
          <div class="authorityEdit">
              <a href="javascript:;" onclick="authorityEdit('edit')">修改</a>
          </div>
      </div>
  </div>
  <script src="__PUBLIC__/js/common.js"></script>
  <script>
      localStorage.removeItem('currentauthority_id_storge')
      //组织结构列表
      var $returnJson = '{$return}' ? JSON.parse('{$return}') : []
      var orglist = $returnJson.orglist
      var $returnArr = []
      Object.keys(orglist).forEach(function (k) {
          $returnArr.push(JSON.parse(JSON.stringify(orglist[k]).replace(/org_name/g,'name').replace(/parentid/g,'pId')))
      })
      var setting = {
          view: {
              fontCss: getFont,
              selectedMulti: false, // 是否允许同时选中多个节点
              addHoverDom:addHoverDom, // 鼠标移动到节点触发的事件
              removeHoverDom:removeHoverDom // 鼠标移开节点触发的事件
          },
          data: {
              simpleData: {
                  enable: true
              }
          },
          callback:{
              beforeCheck:true,
              onCheck:onCheck,
              beforeRemove:beforeRemove,//点击删除时触发，用来提示用户是否确定删除（可以根据返回值 true|false 确定是否可以删除）
              beforeEditName: beforeEditName,//点击编辑时触发，用来判断该节点是否能编辑
              beforeRename:beforeRename,//编辑结束时触发，用来验证输入的数据是否符合要求(也是根据返回值 true|false 确定是否可以编辑完成)
              onRemove:onRemove,//(beforeRemove返回true之后可以进行onRemove)删除节点后触发，用户后台操作
              onRename:onRename,//编辑后触发，用于操作后台
              beforeDrag:beforeDrag,//用户禁止拖动节点
              onClick:clickNode//点击节点触发的事件
          }
      };

      // 获取选中的节点id
      function onCheck(e,treeId,treeNode) {
          var treeObj = $.fn.zTree.getZTreeObj("treeDemo"),
              nodes = treeObj.getCheckedNodes(true),
              v = "",
              oidsVal = '';
          for (var i = 0; i < nodes.length; i++) {
              v += nodes[i].name + ",";
              oidsVal += oidsVal ? ','+nodes[i].id : nodes[i].id
          }
          $(".oids").val(oidsVal)
      }

      $(function(){
          jQuery.fn.zTree.init($("#treeDemo"), setting, $returnArr);
          setCheck();


          //获得树形图对象
          var zTree = $.fn.zTree.getZTreeObj("treeDemo");
          //获取根节点个数,getNodes获取的是根节点的集合
          var nodeList = zTree.getNodes();
          //展开第一个根节点
          zTree.expandNode(nodeList[0], true);
          // 根节点id
          var nodeList_0_id = nodeList[0].id

//      页面刚打开，默认点击的是第一个节点  把它的ID保存到clickNoneId中
          $(".clickNoneId").val(nodeList_0_id)

          // 通过ID获取节点
          var nodeList_0 = zTree.getNodeByParam("id", nodeList_0_id, null)

          // 这种指定节点的样式，要用到updateNode
          nodeList_0.font = {'color': '#3aa8e8'}
          zTree.updateNode(nodeList_0);

          // 给nowNodeName设置值
          $('.nowNodeName').html('').html(nodeList_0.name)


          //展示首个组织结构的权限管理
          getOrgauthority()

          $(".clickNoneId").val(nodeList_0_id)
      });
      function setCheck() {
          var zTree = $.fn.zTree.getZTreeObj("treeDemo")
          zTree.setting.check.chkboxType = { "Y":'', "N":''}
      }
      function beforeRemove(e,treeId,treeNode){
          return confirm("你确定要删除吗？");
      }
      function onRemove(e,treeId,treeNode){
//      移除节点后触发的事件
      }
      function beforeRename(treeId,treeNode,newName,isCancel){
          if(newName.length < 3){
              alert("名称不能少于3个字符！");
              return false;
          }
          return true;
      }
      function onRename(e,treeId,treeNode,isCancel){
          alert("修改节点的id为："+treeNode.id+"\n修改后的名称为："+treeNode.name);
      }
      function beforeEditName(treeId,treeNode){
          return true;
      }
      function beforeDrag(treeId,treeNodes){
          return false;
      }
      function clickNode(e,treeId,treeNode){

        modifyNode(treeNode)

        localStorage.removeItem('currentauthority_id_storge')

        getOrgauthority()

      }
      function addHoverDom(treeId,treeNode){
      }
      function removeHoverDom(treeId,treeNode){
          $("#addBtn_"+treeNode.tId).unbind().remove();
      }

      //    @method 设置节点样式，必须用这个方法（这是zTree插件必须的）
      //    @ params node 当前节点
      function getFont(treeId, node) {
          return node.font ? node.font : {};
      }

      // @methods 获取权限
      // @oid {String} 节点ID
      function getOrgauthority(operation) {
          $('.has_authorityList_value').off('click')
          if(localStorage.getItem('currentauthority_id_storge') === null){
          }else{
              authorityEdit()
          }
          var dataJson = {}
          var currentauthority = []
          var allauthority = []
          var has_authorityList_value = ''
          var totalpage = 0
          var oid = $(".clickNoneId").val()
          var curpage = 1// 第几页
          var psize = 30 // 每页多少条数据

          if (operation === '首页') {
              if (Number($(".personnel_currentPage_orginization").val()) === 1) {
                  return
              } else {
                  curpage = 1
              }
          } else if (operation === '上一页') {
              if (Number($(".authorityList_currentPage_orginization").val()) === 1) {
                  return
              } else {
                  curpage = Number($(".authorityList_currentPage_orginization").val()) - 1
              }
          } else if (operation === '下一页') {
              if (Number($(".authorityList_currentPage_orginization").val()) < Number($(".authorityList_totalpage_orginization").val())) {
                  curpage = Number($(".authorityList_currentPage_orginization").val()) + 1
              } else {
                  return
              }
          } else if(operation ==='尾页'){
              if (Number($(".authorityList_currentPage_orginization").val()) === Number($(".authorityList_totalpage_orginization").val())) {
                  return
              } else {
                  curpage = Number($(".authorityList_totalpage_orginization").val())
              }
          } else if (operation ==='跳转') {
              if (Number($(".pages_orginization").val()) === Number($(".authorityList_currentPage_orginization").val()) || Number($(".pages_orginization").val()) < 1 || Number($(".pages_orginization").val()) > Number($(".authorityList_totalpage_orginization").val())) {
                  return
              } else {
                  curpage = Number($(".pages_orginization").val())
              }
          } else {
              curpage = 1
          }

          var currentauthority_id = [] // 保存当前权限的ID
          var currentauthority_id_storge = []
          var currentauthority_id_storge_local = ''
          $.ajax({
              url: './index.php?g=Orginization&m=Orginization&a=getorgauthority',
              type: 'post',
              data: {oid: oid, curpage: curpage, psize: psize},
              success: function (data) {
                  dataJson = JSON.parse(data)
                  currentauthority = dataJson.currentauthority
                  allauthority = dataJson.allauthority

                  authorityTree(allauthority, currentauthority)
              },
              error: function (error) {
                  console.log(error)
              }
          })
      }
      
      // @methods 权限修改
      // @authority {String} 权限ID
      // @ oid {String} 节点ID
      function authorityEdit(str) {
          onauthorCheck()
          var authority = ''
          var oid = $(".clickNoneId").val()
          var dataJson = {}
          authority = $(".clickNowId").val()
          $.ajax({
             url: './index.php?g=Orginization&m=Orginization&a=editauthority',
             type: 'post',
             data: {oid: oid,authority: authority},
             success: function (data) {
                 dataJson = JSON.parse(data)
                 if(str === 'edit') {
                     if (dataJson.state === true) {
                         alert(dataJson.msg)
                     } else {
                         alert(dataJson.msg)
                     }
                 }
             },
              error: function (error) {
                console.log(error)
              }
          })
      }

      //    @method 修改node节点的样式以及给clickNoneId赋值
      //    @treeNode 节点
      function modifyNode(treeNode) {
          //获得树形图对象
          var zTree = $.fn.zTree.getZTreeObj("treeDemo");

          // 通过ID获取点击之前选择的节点
          var node_old_click_id = $(".clickNoneId").val()
          var node1_old_click = zTree.getNodeByParam("id", node_old_click_id, null);
          // 这种指定节点的样式，要用到updateNode
          node1_old_click.font = {'color': '#333'}
          zTree.updateNode(node1_old_click);

          // 设置当前被点击节点的ID
          $(".clickNoneId").val(treeNode.id)

          // 给nowNodeName设置值
          $('.nowNodeName').html('').html(treeNode.name)

          // 通过ID获取节点
          var node1_new_click = zTree.getNodeByParam("id", treeNode.id, null);

          // 这种指定节点的样式，要用到updateNode
          node1_new_click.font = {'color': '#3aa8e8'}
          zTree.updateNode(node1_new_click);
      }

      // 判断数组里面是否包含某个值
      function isInArray(val, arr){
          for(var i = 0; i < arr.length; i++){
              if(val === arr[i]){
                  return true;
              }
          }
          return false;
      }



      // input的checkbox改变，触发下面的方法
      // 判断当前数组里面有没有这个值，有的话删掉，没有的话加上
      function editArrayList(val) {
          var currentauthority_id_storge = localStorage.getItem('currentauthority_id_storge')
          var arrIndex = 0
          var currentauthority_id_storge_new = ''
          arrIndex = arrContains(val, currentauthority_id_storge)
          currentauthority_id_storge_new = currentauthority_id_storge.split(',')
          if (arrIndex > -1) {
              currentauthority_id_storge_new.splice(arrIndex, 1)
          } else {
              currentauthority_id_storge_new.push(val)
          }
          localStorage.removeItem('currentauthority_id_storge')
          localStorage.setItem('currentauthority_id_storge', currentauthority_id_storge_new.join(','))
      }

      // 获取指定值在数组里的下标
      function arrContains(val, arr) {
          var arrList = arr.split(',')
          for(var i = 0; i < arrList.length; i++) {
              if (arrList[i] === val.toString()) {
                  return i
              }
          }
          return -1
      }

      
      function authorityTree(allauthority, currentauthority) {
          var authorityList = allauthority
          var authorityArr = []
          var newObject

          var currentauthority_id = []
          if(currentauthority.length > 0) {
              for(var i = 0; i < currentauthority.length; i++) {
                  currentauthority_id.push(currentauthority[i].id)
              }
          }

          Object.keys(authorityList).forEach(function (k) {
              newObject = JSON.parse(JSON.stringify(authorityList[k]).replace(/parentid/g,'pId'))
              if (isInArray(newObject.id, currentauthority_id)) {
                  newObject.checked = true
              }
              authorityArr.push(newObject)
          })
          var aySetting = {
              view: {
                  fontCss: getFont,
                  selectedMulti: false, // 是否允许同时选中多个节点
                  addHoverDom:addHoverDom, // 鼠标移动到节点触发的事件
                  removeHoverDom:removeHoverDom // 鼠标移开节点触发的事件
              },
              check: {
                  enable: true
              },
              data: {
                  simpleData: {
                      enable: true
                  }
              },
              callback:{
                  onCheck:onauthorCheck
              }
          };

          jQuery.fn.zTree.init($("#authorityTreeDemo"), aySetting, authorityArr);
          var zTree = $.fn.zTree.getZTreeObj("authorityTreeDemo")
          zTree.setting.check.chkboxType = { "Y":'', "N":''}

          //获得树形图对象
          var zTree = $.fn.zTree.getZTreeObj("authorityTreeDemo");
          //获取根节点个数,getNodes获取的是根节点的集合
          var nodeList = zTree.getNodes();
          //展开第一个根节点
          zTree.expandNode(nodeList[0], true);
      }

      // 获取选中的节点id
      function onauthorCheck(e,treeId,treeNode) {
          var treeObj = $.fn.zTree.getZTreeObj("authorityTreeDemo"),
              nodes = treeObj.getCheckedNodes(true),
              v = "",
              oidsVal = '';
          for (var i = 0; i < nodes.length; i++) {
              v += nodes[i].name + ",";
              oidsVal += oidsVal ? ','+nodes[i].id : nodes[i].id
          }
          $(".clickNowId").val(oidsVal)
      }
  </script>
</body>
</html>