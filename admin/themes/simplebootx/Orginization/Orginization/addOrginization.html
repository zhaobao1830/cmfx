<admintpl file="header" />
<style>
    .wrap-zb{
        overflow: hidden;
    }
    .treeDemo_zb_left{
        width: 23%;
        float: left;
        border: 1px solid #dddddd;
    }
    .orginization_title{
        height: 40px;
        line-height: 40px;
        background-color: #eeeeee;
        border-bottom: 1px solid #dddddd;
        text-align: center;
        color: #4ea0ea;
        font-size: 16px;
    }
    .ztree_zb li span.button.add {
        margin-left:2px;
        margin-right: -1px;
        background-position:-144px 0;
        vertical-align:top;
        *vertical-align:middle
    }
    .zb_authority_ul li{
        list-style: none;
        float: left;
        margin-right: 20px;
    }
    .authority_zb{
        margin: 0 !important;
    }
    ul.ztree{
        margin: 0 !important;
        border: none !important;
        background-color: #fff !important;
        width: auto !important;
        min-height: 200px;
        max-height: 650px;
    }
    .treeDemo_zb_right{
        width: 73%;
        float: left;

    }
    .addNewNode{
        overflow: hidden;
        width: 100%;
    }
    .addNewNode_content{
        border: 1px solid #dddddd;
    }
    .addNewNode_operation{
        text-align: center;
        margin-top: 20px;
    }
    .addNewNode_operation > a{
        display: inline-block;
        height: 30px;
        line-height: 30px;
        color: #fff;
        background-color: #3daae9;
        border-radius: 4px;
        text-decoration: none;
        padding: 0 15px;
    }
    .addNewNode_operation > a:hover{
        background-color: #3daae9;
    }
    .addNewNode_submission{
        margin-right: 20px;
    }
    .addNewNode_con{
        width: 100%;
        padding: 0 20px 0 0;
    }
    .spanFont{
        font-size: 14px;
        color: #464646;
        margin-left: 10px !important;
        height: 30px;
        line-height: 30px;
        width: 70px;
        text-align: right;
        float: left;
    }
    .briefIntroduction_val_div{
        margin-left: 80px;
    }
    .mt{
        margin-top: 20px;
    }
    .organizationName_val{
        width: 300px;
    }
    .briefIntroduction_val{
        width: 96%;
        min-height: 100px;
        padding: 10px;
        resize: vertical;
    }
    .administrators{
        position: relative;
    }
    .administrators_con{
        padding: 30px 0 70px;
        overflow: hidden;
    }
    .administrators_con > label {
        margin-left: 20px;
        overflow: hidden;
        display: inline-block;
    }
    .administrators_con_input{
        margin: 0;
        display: inline-block;
        float: left;
    }
    .administrators_con_span{
        color: #464646;
        font-size: 14px;
        margin: 0;
        display: inline-block;
        margin-left: 10px;
    }
    .ztree li span.button.edit{
        background-position: -107px -47px !important;
    }



    .searchPerson{
        height: 70px;
        line-height: 70px;
        margin: 10px 0 0 0;
        background-color: #f5f5f5;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
    }
    .searchPerson p{
        display: inline-block;
        margin-left: 20px;
        border: none !important;
    }
    .searchPerson input{
        margin-bottom: 0 !important;
    }
    .searchPerson a{
        display: inline-block;
        height: 28px;
        line-height: 28px;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        font-size: 12px;
        color: #000000;
        margin-left: 5px;
        padding: 0 10px;
        text-decoration: none;
    }
    .searchPerson a:hover{
        background-color: #3aa8e8;
    }

    /*分页 start*/
    .paginationUserList{
        margin: 0 0 0 10px;
        position: absolute;
        bottom: 10px;
    }
    .pagination>a{
        color: #4ea0ea !important;
    }
    .paginationUserList a{
        display: block;
        line-height: 30px !important;
        height: 30px !important;
        text-align: center;
        font-size: 12px;
        cursor: pointer;
        text-decoration: none !important;
    }
    .paginationUserList a:hover{
        background-color: #3aa8e8 !important;
    }
    .tableButton_orginization{
        width: 390px;
        float: right;
        margin-right: 20px;
        margin-top: 20px;
    }
    .goFirst_orginization,.goLast_orginization,.prePage_orginization,.nextPage_orginization{
        border: 1px solid #bbbbbb;
        background-color: #fafafa;
        color: #777777;
        border-radius: 2px;
        float: left;
    }
    .goFirst_orginization,.goLast_orginization{
        width: 44px;
    }
    .prePage_orginization,.nextPage_orginization{
        width: 56px;
    }
    .prePage_orginization{
        margin-left: 5px;
    }
    .nextPage_orginization{
        margin-right: 5px;
    }
    .currentPage_countPage_orginization{
        width: 45px;
        float: left;
        color: #3aa8e8;
        text-align: center;
        height: 30px;
        line-height: 30px;
    }
    .pages_orginization{
        display: block !important;
        width: 44px;
        height: 28px !important;
        line-height: 30px !important;
        text-align: center;
        border: 1px solid #3aa8e8;
        padding: 0 !important;
        margin-left: 5px;
        margin-right: 5px;
        margin-bottom: 0 !important;
        border-radius: 2px;
        float: left;
        color: #3aa8e8;
    }
    .goPage_orginization{
        width: 44px;
        height: 30px;
        line-height: 30px;
        color: white;
        border-radius: 2px;
        font-size: 14px;
        background-color: #3aa8e8;
        float: left;
    }
    .goPage_orginization:hover{
        background-color: #4986c6;
    }
    /*分页 end*/
    .displayNone{
        display: none;
    }
    .displayBlock{
        display: block;
    }
</style>
</head>
<body>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/ztree/demo.css?111">
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/ztree/zTreeStyle.css">
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.core.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.all.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.exedit.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/ztree/jquery.ztree.exhide.js"></script>
<div class="wrap wrap-zb">
    <!--保存当前点击的节点的ID-->
    <input type="hidden" class="clickNoneId" value="">
    <div class="treeDemo_zb_left span3">
        <div class="ztree_zb_title orginization_title">组织树</div>
        <div class="ztree_zb_ul">
            <ul id="treeDemo" class="ztree ztree_zb"></ul>
        </div>
    </div>
    <div class="treeDemo_zb_right span9">
        <div class="addNewNode">
            <div class="addNewNode_content">
                <div class="addNewNode_title orginization_title"><span class="nowNodeName"></span>--添加新节点</div>
                <div class="addNewNode_con">
                    <div class="organizationName mt">
                        <div class="spanFont">组织名称：</div>
                        <input type="text" class="organizationName_val orgname">
                    </div>
                    <div class="briefIntroduction mt">
                        <div class="spanFont">简介：</div>
                        <div class="briefIntroduction_val_div">
                            <textarea class="briefIntroduction_val orginfo" cols="3"></textarea>
                        </div>
                    </div>
                    <div class="administrators mt">
                        <div class="searchPerson">
                            <p>管理员：</p>
                            <input type="text" class="searchPerson_input">
                            <a href="javascript:;" onclick="noorgsearch()">搜索</a>
                        </div>
                        <div class="administrators_con"></div>
                        <div class="table_button_orginization_unorganized1 paginationUserList displayNone">
                            <div class="tableButton_orginization">
                                <a class="goFirst_orginization" onclick="noorgsearch('首页')">首页</a>
                                <a class="prePage_orginization" onclick="noorgsearch('上一页')">上一页</a>
                                <p class="unorganized1_currentPage_countPage_orginization currentPage_countPage_orginization"></p>
                                <input type="hidden" class="unorganized1_currentPage_orginization" value="0">
                                <input type="hidden" class="unorganized1_totalpage_orginization" value="">
                                <a class="nextPage_orginization" onclick="noorgsearch('下一页')">下一页</a>
                                <a class="goLast_orginization" onclick="noorgsearch('尾页')">尾页</a>
                                <input type="text" value="" class="unorganized1_pages_orginization pages_orginization">
                                <a class="goPage_orginization" onclick="noorgsearch('跳转')">跳转</a>
                            </div>
                        </div>
                        <div class="table_button_orginization_unorganized paginationUserList displayNone">
                            <div class="tableButton_orginization">
                                <a class="goFirst_orginization" onclick="noorguser('首页')">首页</a>
                                <a class="prePage_orginization" onclick="noorguser('上一页')">上一页</a>
                                <p class="unorganized_currentPage_countPage_orginization currentPage_countPage_orginization"></p>
                                <input type="hidden" class="unorganized_currentPage_orginization" value="0">
                                <input type="hidden" class="unorganized_totalpage_orginization" value="">
                                <a class="nextPage_orginization" onclick="noorguser('下一页')">下一页</a>
                                <a class="goLast_orginization" onclick="noorguser('尾页')">尾页</a>
                                <input type="text" value="" class="unorganized_pages_orginization pages_orginization">
                                <a class="goPage_orginization" onclick="noorguser('跳转')">跳转</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="addNewNode_operation">
                <a href="javascript:;" class="addNewNode_submission" onclick="addNewNode_submission()">提交</a>
                <a href="javascript:;" class="addNewNode_cancel" onclick="addNewNode_cancel()">取消</a>
            </div>
        </div>
    </div>
</div>
<script>
      var PSIZE = 20

      // 组织结构
      var orginfo = '{$orginfo}' ? JSON.parse('{$orginfo}') : {}
      var orglistNew = []
      if (orginfo) {
          Object.keys(orginfo).forEach(function (k) {
              orglistNew.push(JSON.parse(JSON.stringify(orginfo[k]).replace(/org_name/g,'name').replace(/parentid/g,'pId')))
          })
      }

      // id 当前节点的id
      var now_node_id = '{$id}'
      $(".clickNoneId").val(now_node_id)

      //    ztree 操作 start
      var setting = {
          view: {
              fontCss: getFont,
              selectedMulti: false, // 是否允许同时选中多个节点
              addHoverDom:addHoverDom, // 鼠标移动到节点触发的事件
              removeHoverDom:removeHoverDom // 鼠标移开节点触发的事件
          },
          data: {
              simpleData: {
                  enable: true
              }
          },
          callback:{
              beforeCheck:true,
              onCheck:onCheck,
              onClick:clickNode //点击节点触发的事件
          }
      };
      // 获取选中的节点id
      function onCheck(e,treeId,treeNode) {
          var treeObj = $.fn.zTree.getZTreeObj("treeDemo"),
              nodes = treeObj.getCheckedNodes(true),
              v = "",
              oidsVal = '';
          for (var i = 0; i < nodes.length; i++) {
              v += nodes[i].name + ",";
              oidsVal += oidsVal ? ','+nodes[i].id : nodes[i].id
          }
          $(".oids").val(oidsVal)
      }
      $(function(){
          jQuery.fn.zTree.init($("#treeDemo"), setting, orglistNew)
          setCheck()

          nowClickId_operation()

          noorguser()
      });
      function setCheck() {
          var zTree = $.fn.zTree.getZTreeObj("treeDemo")
          zTree.setting.check.chkboxType = { "Y":'', "N":''}
      }
      function addHoverDom(treeId,treeNode){
          if (treeNode.level < 2) {
              var sObj = $("#" + treeNode.tId + "_span");
              if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
              var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                  + "' title='添加子节点' onfocus='this.blur();'></span>";
              sObj.after(addStr);
              var btn = $("#addBtn_"+treeNode.tId);
              if (btn) btn.bind("click", function(e){
                  // 提交的时候把   http://localhost:8081  更改成   http://lbpx.crecgec.cn
                  window.location.href = './index.php?g=Orginization&m=Orginization&a=addorg&pId='+treeNode.id+'&id='+treeNode.id

                  //在这里向后台发送请求保存一个新建的叶子节点，父id为treeNode.id,让后将下面的100+newCount换成返回的id
                  return false;
              });
          }
      }
      function removeHoverDom(treeId,treeNode){
          $("#addBtn_"+treeNode.tId).unbind().remove();
      }

      //    ztree 操作 end

    // 提交
    function addNewNode_submission() {
        // pid 点击节点的parentid
        var parentid =  '{$pid}'
        var orgname = $(".orgname").val()
        var orginfo = $('.orginfo').val()
        var adminid = $('input[name="administrators_con_input"]:checked').val()
        var clickNoneId = $(".clickNoneId").val()
        var orglist = [] //组织结构
        var flag = true
        if (orgname) {
            flag = true
        } else {
            flag = false
            alert('请填写组织名称!')
        }
        if (adminid) {
            flag = true
        } else {
            flag = false
            alert('请选择管理员!')
        }
        var data = {
            parentid: parentid,
            orgname: orgname,
            orginfo: orginfo,
            adminid: adminid
        }
        if (flag) {
            $.ajax({
                url: './index.php?g=Orginization&m=Orginization&a=addorginization',
                type: 'post',
                data: data,
                success: function (data) {
                    if (JSON.parse(data).state === 'success') {
                        alert(JSON.parse(data).msg)
                        window.location.href = './index.php?g=Orginization&m=Orginization&a=addorg&pId='+parentid+'&id='+parentid
                    } else {
                        alert(JSON.parse(data).msg)
                    }
                },
                error: function (err) {
                    console.log(err)
                }
            })
        }
    }
    // 取消
    function addNewNode_cancel() {
        $(".orgname").val('')
        $('.orginfo').val('')
        $('input[name="administrators_con_input"]').prop("checked",false)
    }
    
    // 通过当前点击的节点的ID进行一些操作
    function nowClickId_operation() {
        //获得树形图对象
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");

        // 被点击的节点的id
        var click_id = $(".clickNoneId").val()

        // 通过ID获取节点
        var nodeNow = zTree.getNodeByParam("id", click_id, null)
        //通过被点击的节点，展开它的父节点
        var nodeNowParent = zTree.getNodeByParam("id", nodeNow.pId, null)
        zTree.expandNode(nodeNowParent, true);

        // 通过指定节点获取它的父节点，并展开
//        var nodeNowParent = zTree.getNodeByParam("id", nodeNow.pId, null)
//        zTree.expandNode(nodeNowParent);

        // 这种指定节点的样式，要用到updateNode
        nodeNow.font = {'color': '#3aa8e8'}
        zTree.updateNode(nodeNow, true, true);

        // 给nowNodeName设置值
        $('.nowNodeName').html('').html(nodeNow.name)
    }
    function getFont(treeId, node) {
       return node.font ? node.font : {};
    }

    function clickNode(e,treeId,treeNode) {
        window.location.href = './index.php?g=Orginization&m=Orginization&a=index&orgoid='+treeNode.id
    }

      // @methods 无组织用户列表
      function noorguser(operation) {
          var curpage = 1// 第几页
          var psize = PSIZE // 每页多少条数据
          if (operation === '首页') {
              if (Number($(".unorganized_currentPage_orginization").val()) === 1) {
                  return
              } else {
                  curpage = 1
              }
          } else if (operation === '上一页') {
              if (Number($(".unorganized_currentPage_orginization").val()) === 1) {
                  return
              } else {
                  curpage = Number($(".unorganized_currentPage_orginization").val()) - 1
              }
          } else if (operation === '下一页') {
              if (Number($(".unorganized_currentPage_orginization").val()) < Number($(".unorganized_totalpage_orginization").val())) {
                  curpage = Number($(".unorganized_currentPage_orginization").val()) + 1
              } else {
                  return
              }
          } else if(operation ==='尾页'){
              if (Number($(".unorganized_currentPage_orginization").val()) === Number($(".unorganized_totalpage_orginization").val())) {
                  return
              } else {
                  curpage = Number($(".unorganized_totalpage_orginization").val())
              }
          } else if (operation ==='跳转') {
              if (Number($(".unorganized_pages_orginization").val()) === Number($(".unorganized_currentPage_orginization").val()) || Number($(".unorganized_pages_orginization").val()) < 1 || Number($(".unorganized_currentPage_orginization").val()) > Number($(".unorganized_totalpage_orginization").val())) {
                  return
              } else {
                  curpage = Number($(".unorganized_pages_orginization").val())
              }
          } else if (operation ==='当前') {
              curpage = Number($(".unorganized_currentPage_orginization").val())
          } else {
              curpage = 1
          }
          var noorgusersJson = {},noorgusers='',unorganizedUserList_value = '',totalpage='',administrators_con = '';

          $.ajax({
              url: './index.php?g=Orginization&m=Orginization&a=noorguser',
              type: 'post',
              data: {curpage: curpage, psize: psize},
              success: function (data) {
                  noorgusersJson = JSON.parse(data)
                  // 无组织用户列表
                  noorgusers = noorgusersJson.userlist

                  if (noorgusers.length > 0) {
                      noorgusers.forEach(function (k) {
                          administrators_con += '<label><input type="radio" name="administrators_con_input" class="administrators_con_input" value="'+k.id+'"><span class="administrators_con_span">'+k.user_login+'</span></label>'
                      })
                      $(".administrators_con").html('')
                      $(".administrators_con").html(administrators_con)
                  } else {
                      $(".administrators_con").html('')
                  }

                  // 总页数
                  totalpage = noorgusersJson.totalpage

                  $(".unorganized_currentPage_orginization").val(curpage)
                  $(".unorganized_totalpage_orginization").val(totalpage)
                  $(".unorganized_currentPage_countPage_orginization").html('').html(curpage+"/"+totalpage)

                  // 总页数
                  if (totalpage > 1) {
                      $(".table_button_orginization_unorganized").removeClass('displayNone').addClass('displayBlock')
                  } else {
                      $(".table_button_orginization_unorganized").removeClass('displayBlock').addClass('displayNone')
                  }
              },
              error: function (error) {
                  console.log(error)
              }
          })
      }


      // 搜索用户
      //    @params {String} username
      //    @return {数组型字符串} data
      function noorgsearch(operation) {
          var username = $('.searchPerson_input').val().trim()
          var unorganizedUserList_value = ''
          var dataJson = {}
          var curpage = 1// 第几页
          var psize = PSIZE // 每页多少条数据
          var totalpage = 0
          if (operation === '首页') {
              if (Number($(".unorganized1_currentPage_orginization").val()) === 1) {
                  return
              } else {
                  curpage = 1
              }
          } else if (operation === '上一页') {
              if (Number($(".unorganized1_currentPage_orginization").val()) === 1) {
                  return
              } else {
                  curpage = Number($(".unorganized1_currentPage_orginization").val()) - 1
              }
          } else if (operation === '下一页') {
              if (Number($(".unorganized1_currentPage_orginization").val()) < Number($(".unorganized1_totalpage_orginization").val())) {
                  curpage = Number($(".unorganized1_currentPage_orginization").val()) + 1
              } else {
                  return
              }
          } else if(operation ==='尾页'){
              if (Number($(".unorganized1_currentPage_orginization").val()) === Number($(".unorganized1_totalpage_orginization").val())) {
                  return
              } else {
                  curpage = Number($(".unorganized1_totalpage_orginization").val())
              }
          } else if (operation ==='跳转') {
              if (Number($(".unorganized1_pages_orginization").val()) === Number($(".unorganized1_currentPage_orginization").val()) || Number($(".unorganized1_pages_orginization").val()) < 1 || Number($(".unorganized1_pages_orginization").val()) > Number($(".unorganized1_totalpage_orginization").val())) {
                  return
              } else {
                  curpage = Number($(".unorganized1_pages_orginization").val())
              }
          } else if (operation ==='当前') {
              curpage = Number($(".unorganized1_currentPage_orginization").val())
          } else {
              curpage = 1
          }
          $.ajax({
              url: './index.php?g=Orginization&m=Orginization&a=noorgsearch',
              type: 'post',
              data: {username: username,curpage: curpage,psize: psize},
              success: function (data) {
                  $(".table_button_orginization_unorganized").removeClass('displayBlock').addClass('displayNone')
                  if (data) {
                      dataJson = JSON.parse(data)
                      dataJson.userlist.forEach(function (k) {
                          unorganizedUserList_value += '<label><input type="radio" name="administrators_con_input" class="administrators_con_input" value="'+k.id+'"><span class="administrators_con_span">'+k.user_login+'</span></label>'
                      })
                      $('.administrators_con').html('')
                      $('.administrators_con').html(unorganizedUserList_value)

                      // 总页数
                      totalpage = dataJson.totalpage

                      $(".unorganized1_currentPage_orginization").val(curpage)
                      $(".unorganized1_totalpage_orginization").val(totalpage)
                      $(".unorganized1_currentPage_countPage_orginization").html('').html(curpage+"/"+totalpage)

                      // 总页数
                      if (totalpage > 1) {
                          $(".table_button_orginization_unorganized1").removeClass('displayNone').addClass('displayBlock')
                      } else {
                          $(".table_button_orginization_unorganized1").removeClass('displayBlock').addClass('displayNone')
                      }
                  }
              },
              error: function (err) {
                  console.log(err)
              }
          })
      }

  </script>
</body>
</html>